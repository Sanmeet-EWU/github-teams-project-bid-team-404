---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import BaseHead from '../components/BaseHead.astro';
import "../styles/profile.css";
---

<html lang="en">
<BaseHead/>
<body>
  <Header/>
  <main class="profile-main">
    <div class="profile-header">
      <div class="profile-picture">
        <img id="profile-picture" src="/images/default-avatar-icon-of-social-media-user-vector.jpg" alt="Profile Picture">
      </div>
      <div class="profile-info">
        <h1 id="profile-username">No Username</h1>
        <p id="profile-bio">No Bio</p>
        <div class="profile-social">
          <a href="#" id="social-facebook">Facebook</a>
          <a href="#" id="social-twitter">Twitter</a>
          <a href="#" id="social-instagram">Instagram</a>
        </div>
      </div>
    </div>
    <div class="profile-stats">
      <div class="stat-item">Posts<br><span id="posts-count">0</span></div>
      <div class="stat-item">Comments<br><span id="comments-count">0</span></div>
      <div class="stat-item">Suggestions<br><span id="suggestions-count">0</span></div>
      <div class="stat-item">Like/Dislike<br><span id="likes-count">0</span></div>
    </div>
    <div class="profile-posts" id="profile-posts">
      Loading posts...
    </div>
    <button id="edit-button">Edit Profile</button>
    <form id="profileForm" style="display: none;">
      <label for="username">Username</label>
      <input type="text" id="username">
      <label for="bio">Bio</label>
      <textarea id="bio"></textarea>
      <label for="profileImageUpload">Upload Profile Picture</label>
      <input type="file" id="profileImageUpload" accept="image/*">
      <label for="facebook">Facebook URL</label>
      <input type="text" id="facebook">
      <label for="twitter">Twitter URL</label>
      <input type="text" id="twitter">
      <label for="instagram">Instagram URL</label>
      <input type="text" id="instagram">
      <button type="submit">Update Profile</button>
    </form>
    <p id="profileSuccessMessage"></p>
    <p id="profileErrorMessage"></p>
  </main>
  <Footer/>

  <!-- Modal for Cropping Image -->
  <div id="crop-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span id="close-crop-modal" class="close">&times;</span>
      <img id="image-preview" src="">
      <button id="crop-button">Crop Image</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"/>

  <script type="module">
    import { collection, getDocs, query, where, doc, setDoc } from "../../node_modules/firebase/firestore";
    import { onAuthStateChanged } from "../../node_modules/firebase/auth";
    import { db, auth } from '../src/firebaseConfig.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from "../../node_modules/firebase/storage";

    console.log("Initializing Firebase...");

    const storage = getStorage();
    let cropper;
    let isEditing = false;

    async function fetchUserData(userEmail) {
      console.log("Fetching user data for email:", userEmail);

      if (!userEmail) {
        console.error("No user email found.");
        return;
      }

      try {
        const userQuery = query(collection(db, "users"), where("email", "==", userEmail));
        const querySnapshot = await getDocs(userQuery);

        if (!querySnapshot.empty) {
          const userDoc = querySnapshot.docs[0];
          const userData = userDoc.data();
          console.log("User data fetched:", userData);
          displayUserData(userData);
        } else {
          console.error("User not found.");
        }
      } catch (error) {
        console.error("Error fetching user data:", error);
      }
    }

    function displayUserData(userData) {
      document.getElementById("profile-username").textContent = userData.username || "No Username";
      document.getElementById("profile-bio").textContent = userData.bio || "No Bio";
      document.getElementById("profile-picture").src = userData.profilePic || '/images/default-avatar-icon-of-social-media-user-vector.jpg';
      document.getElementById("social-facebook").href = userData.facebook || "#";
      document.getElementById("social-twitter").href = userData.twitter || "#";
      document.getElementById("social-instagram").href = userData.instagram || "#";

      // Populate the form fields with the current user data
      document.getElementById("username").value = userData.username || "";
      document.getElementById("bio").value = userData.bio || "";
      document.getElementById("facebook").value = userData.facebook || "";
      document.getElementById("twitter").value = userData.twitter || "";
      document.getElementById("instagram").value = userData.instagram || "";
    }

    function toggleEdit() {
      isEditing = !isEditing;
      document.getElementById('profileForm').style.display = isEditing ? 'block' : 'none';
      document.getElementById('edit-button').textContent = isEditing ? 'Cancel' : 'Edit Profile';
    }

    document.getElementById('profileImageUpload').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('image-preview').src = e.target.result;
          document.getElementById('crop-modal').style.display = 'block';
          if (cropper) {
            cropper.destroy();
          }
          cropper = new Cropper(document.getElementById('image-preview'), {
            aspectRatio: 1,
            viewMode: 1,
            background: false,
          });
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('crop-button').addEventListener('click', function() {
      const canvas = cropper.getCroppedCanvas({
        width: 150,
        height: 150,
      });
      canvas.toBlob(async function(blob) {
        const user = auth.currentUser;
        if (user) {
          const userId = user.uid;
          const fileName = `profile_${userId}.png`;
          const storageRef = ref(storage, `profile_pictures/${userId}/${fileName}`);
          await uploadBytes(storageRef, blob);
          const profilePicURL = await getDownloadURL(storageRef);
          document.getElementById('profilePicture').value = profilePicURL;
          document.getElementById('profile-picture').src = profilePicURL;
          document.getElementById('crop-modal').style.display = 'none';
        }
      }, 'image/png');
    });

    document.getElementById('close-crop-modal').addEventListener('click', function() {
      document.getElementById('crop-modal').style.display = 'none';
    });

    async function fetchUserPosts(userEmail) {
      console.log("Fetching posts for user:", userEmail);

      try {
        const postsQuery = query(collection(db, "posts"), where("userEmail", "==", userEmail));
        const querySnapshot = await getDocs(postsQuery);

        const postsContainer = document.getElementById("profile-posts");
        postsContainer.innerHTML = ""; // Clear loading text

        if (querySnapshot.empty) {
          postsContainer.innerHTML = "No Posts Yet!";
        } else {
          querySnapshot.forEach((doc) => {
            const postData = doc.data();
            const postElement = document.createElement("div");
            postElement.classList.add("post-item");
            postElement.innerHTML = `
              <h3>${postData.title}</h3>
              <p>${postData.content}</p>
            `;
            postsContainer.appendChild(postElement);
          });
        }
      } catch (error) {
        console.error("Error fetching posts:", error);
      }
    }

    async function updateUserData(event) {
      event.preventDefault();
      console.log("Updating user data...");

      const username = document.getElementById('username').value;
      const bio = document.getElementById('bio').value;
      const profilePicture = document.getElementById('profilePicture').value;
      const facebook = document.getElementById('facebook').value;
      const twitter = document.getElementById('twitter').value;
      const instagram = document.getElementById('instagram').value;

      try {
        const user = auth.currentUser;
        if (user) {
          const userId = user.uid;
          await setDoc(doc(db, 'users', userId), {
            username,
            bio,
            profilePic: profilePicture,
            facebook,
            twitter,
            instagram
          }, { merge: true });

          document.getElementById('profileSuccessMessage').textContent = 'Profile updated successfully!';
          document.getElementById('profileErrorMessage').textContent = '';
          console.log("Profile updated successfully.");

          // Update displayed data
          document.getElementById('profile-username').textContent = username;
          document.getElementById('profile-bio').textContent = bio;
          document.getElementById('profile-picture').src = profilePicture;
          document.getElementById('social-facebook').href = facebook || "#";
          document.getElementById('social-twitter').href = twitter || "#";
          document.getElementById('social-instagram').href = instagram || "#";

          // Exit edit mode
          toggleEdit();
        } else {
          throw new Error('No user is signed in');
        }
      } catch (error) {
        document.getElementById('profileErrorMessage').textContent = `Error updating profile: ${error.message}`;
        document.getElementById('profileSuccessMessage').textContent = '';
        console.error("Error updating profile:", error);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      console.log("Page loaded. Checking auth state...");
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const userEmail = user.email;
          console.log("User is signed in:", user);
          fetchUserData(userEmail);
          fetchUserPosts(userEmail);
        } else {
          console.error("No user is signed in.");
        }
      });
      document.getElementById('edit-button').addEventListener('click', toggleEdit);
      document.getElementById('profileForm').addEventListener('submit', updateUserData);
    });
  </script>

</body>
</html>