---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import BaseHead from '../components/BaseHead.astro';
import "../styles/profile.css"
---

<html lang="en">
<BaseHead/>
<body>

    <Header/>
    <main class="profile-main">
      <div id="output-container">
        <input id="outputId" value="" readonly>
      </div>
    
      <section class="profile-section">
        <div id="elements">Loading...</div>
      </section>
    </main>
    <Footer/>

<script>
  import { initializeApp } from "firebase/app";
  import { getFirestore, collection, query, where, getDocs } from "firebase/firestore";

  // Initialize Firebase
  const firebaseConfig = {
    apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
    authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
    projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
    storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
    appId: import.meta.env.PUBLIC_FIREBASE_APP_ID,
    measurementId: import.meta.env.PUBLIC_FIREBASE_MEASUREMENT_ID
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function fetchUserData() {
    // Gather the parameters from the URL
    const params = new URLSearchParams(window.location.search.slice(1));
    let userEmail = params.get("userEmail");

    let output = document.getElementById("outputId");

    if (!userEmail) {
      if (output) {
        output.innerHTML = "<p>No user email provided in URL.</p>";
      }
      console.log("No user email provided in URL.");
      return;
    }

    console.log("User email from URL:", userEmail);

    // Fetch the user data from Firestore
    const userQuery = query(collection(db, "users"), where("email", "==", userEmail));
    try{
        const querySnapshot = await getDocs(userQuery);

        if(!querySnapshot.empty){
            const userDoc = querySnapshot.docs[0];
            const userData = userDoc.data();
            console.log("User data:", userData);
            displayUserData(userData);
        } else {
            if(output){
                output.innerHTML = "<p>No user data found.</p>";
            }
            console.log("No user data found.");
        }
    } catch (error) {
        console.error("Error fetching user data:", error);
        if(output){
            output.innerHTML = "<p>Error fetching user data.</p>";
        }
        console.error("Error fetching user data:", error);
    }
  }

  function displayUserData(userData) {
    let htmlCode = `
      <div class="profile-container">
        <h2>${userData.profileName || "No Name"}</h2>
        <p>Email: ${userData.email}</p>
        <p>Username: ${userData.username || "No Username"}</p>
        <p>Bio: ${userData.bio || "No Bio"}</p>
        <img src="${userData.profilePic || 'default.jpg'}" alt="Profile Picture" class="profile-pic">
      </div>
    `;

    let output = document.getElementById("outputId");
    if (output) {
      output.innerHTML = htmlCode;
    }
  }

  // Fetch user data when the page loads
  window.addEventListener('DOMContentLoaded', fetchUserData);
</script>

</body>
</html>