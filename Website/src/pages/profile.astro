---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import BaseHead from '../components/BaseHead.astro';
import "../styles/profile.css";
---

<html lang="en">
<BaseHead/>
<body>
  <Header/>
  <main class="profile-main">
    <div class="profile-header">
      <div class="profile-picture">
        <img id="profile-picture" src="default-profile-pic.png" alt="Profile Picture">
      </div>
      <div class="profile-info">
        <h1 id="profile-username">No Username</h1>
        <p id="profile-bio">No Bio</p>
        <div class="profile-social">
          <a href="#" id="social-facebook">Facebook</a>
          <a href="#" id="social-twitter">Twitter</a>
          <a href="#" id="social-instagram">Instagram</a>
        </div>
      </div>
    </div>
    <div class="profile-stats">
      <div class="stat-item">Posts <span id="posts-count">0</span></div>
      <div class="stat-item">Comments <span id="comments-count">0</span></div>
      <div class="stat-item">Suggestions <span id="suggestions-count">0</span></div>
      <div class="stat-item">Like/Dislike <span id="likes-count">0</span></div>
    </div>
    <div class="profile-posts" id="profile-posts">
      Loading posts...
    </div>
  </main>
  <Footer/>

  <script type="module">
    import { collection, getDocs, query, where, doc, setDoc } from "../../node_modules/firebase/firestore";
    import { onAuthStateChanged } from "../../node_modules/firebase/auth";
    import { db, auth } from '../src/firebaseConfig.js';

    console.log("Initializing Firebase...");

    async function fetchUserData(userEmail) {
      console.log("Fetching user data for email:", userEmail);

      if (!userEmail) {
        console.error("No user email found.");
        return;
      }

      try {
        const userQuery = query(collection(db, "users"), where("email", "==", userEmail));
        const querySnapshot = await getDocs(userQuery);

        if (!querySnapshot.empty) {
          const userDoc = querySnapshot.docs[0];
          const userData = userDoc.data();
          console.log("User data fetched:", userData);
          displayUserData(userData);
        } else {
          console.error("User not found.");
        }
      } catch (error) {
        console.error("Error fetching user data:", error);
      }
    }

    function displayUserData(userData) {
      document.getElementById("profile-username").textContent = userData.username || "No Username";
      document.getElementById("profile-bio").textContent = userData.bio || "No Bio";
      document.getElementById("profile-picture").src = userData.profilePic || 'default-profile-pic.png';
      // Add more social links or other details as needed
    }

    async function fetchUserPosts(userEmail) {
      console.log("Fetching posts for user:", userEmail);

      try {
        const postsQuery = query(collection(db, "posts"), where("userEmail", "==", userEmail));
        const querySnapshot = await getDocs(postsQuery);

        const postsContainer = document.getElementById("profile-posts");
        postsContainer.innerHTML = ""; // Clear loading text

        querySnapshot.forEach((doc) => {
          const postData = doc.data();
          const postElement = document.createElement("div");
          postElement.classList.add("post-item");
          postElement.innerHTML = `
            <h3>${postData.title}</h3>
            <p>${postData.content}</p>
          `;
          postsContainer.appendChild(postElement);
        });

      } catch (error) {
        console.error("Error fetching posts:", error);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      console.log("Page loaded. Checking auth state...");
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const userEmail = user.email;
          console.log("User is signed in:", user);
          fetchUserData(userEmail);
          fetchUserPosts(userEmail);
        } else {
          console.error("No user is signed in.");
        }
      });
    });
  </script>

</body>
</html>